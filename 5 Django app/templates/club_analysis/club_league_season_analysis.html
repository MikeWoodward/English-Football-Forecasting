{% extends 'base.html' %}

{% block title %}Club League and Season Analysis - English Football League Analysis{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title text-center mb-0">Club League and Season Analysis</h1>
            </div>
            <div class="card-body">
                {% if has_api_key %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <p>
                                This page provides AI powered textual analysis of 
                                a club's performance during a season. Select the 
                                club, the season, and press 'Get analysis' to see 
                                the results. You'll only see season once you've 
                                selected a club, and you'll only see 'Get 
                                analysis' when you've selected a club and season. 
                                Note that there will be a delay of a 30 seconds 
                                while I call the AI and prepare the results.
                            </p>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="club-select" class="form-label">
                                Select a Club:
                            </label>
                            <select class="form-select" id="club-select"
                                    onchange="handleClubSelection()">
                                <option value="">-- Select a Club --</option>
                                {% for club in clubs %}
                                    <option value="{{ club }}">{{ club }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4" id="season-container" 
                             style="display: none;">
                            <label for="season-select" class="form-label">
                                Select a Season:
                            </label>
                            <select class="form-select" id="season-select"
                                    onchange="handleSeasonSelection()">
                                <option value="">-- Select a Season --</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4" id="analysis-button-container" 
                             style="display: none;">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-primary"
                                        id="get-analysis-btn"
                                        onclick="handleGetAnalysis()">
                                    Get analysis
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4" id="club_season_text_analysis" 
                         style="display: none;">
                        <div class="col-12">
                        </div>
                    </div>
                {% else %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <p>
                                I can't access the AI engine, so this 
                                functionality isn't available right now. Please 
                                contact Mike Woodward and tell him you've found a 
                                problem.
                            </p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedClub = '';
let selectedSeason = '';

function handleClubSelection() {
    const selectElement = document.getElementById('club-select');
    const selectedClubValue = selectElement.value;
    
    if (selectedClubValue) {
        selectedClub = selectedClubValue;
        // Show season dropdown and fetch seasons
        document.getElementById('season-container').style.display = 'block';
        fetchSeasons(selectedClubValue);
        // Hide analysis button and results
        document.getElementById('analysis-button-container').style.display = 
            'none';
        document.getElementById('club_season_text_analysis').style.display = 
            'none';
        selectedSeason = '';
    } else {
        selectedClub = '';
        // Hide season dropdown, analysis button, and results
        document.getElementById('season-container').style.display = 'none';
        document.getElementById('analysis-button-container').style.display = 
            'none';
        document.getElementById('club_season_text_analysis').style.display = 
            'none';
        selectedSeason = '';
    }
}

function fetchSeasons(clubName) {
    const seasonSelect = document.getElementById('season-select');
    // Clear existing options except the first one
    seasonSelect.innerHTML = '<option value="">-- Select a Season --</option>';
    
    // Fetch seasons for the selected club
    fetch('{% url "club_analysis:club_league_season_analysis" %}?club=' + 
          encodeURIComponent(clubName))
        .then(response => response.json())
        .then(data => {
            // Populate season dropdown
            data.seasons.forEach(season => {
                const option = document.createElement('option');
                option.value = season;
                option.textContent = season;
                seasonSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching seasons:', error);
        });
}

function handleSeasonSelection() {
    const selectElement = document.getElementById('season-select');
    const selectedSeasonValue = selectElement.value;
    
    if (selectedSeasonValue && selectedClub) {
        selectedSeason = selectedSeasonValue;
        // Show analysis button
        document.getElementById('analysis-button-container').style.display = 
            'block';
        // Hide previous results
        document.getElementById('club_season_text_analysis').style.display = 
            'none';
    } else {
        selectedSeason = '';
        // Hide analysis button and results
        document.getElementById('analysis-button-container').style.display = 
            'none';
        document.getElementById('club_season_text_analysis').style.display = 
            'none';
    }
}

function handleGetAnalysis() {
    if (!selectedClub || !selectedSeason) {
        return;
    }
    
    // Show loading state
    const analysisContainer = document.getElementById(
        'club_season_text_analysis'
    );
    const analysisContent = analysisContainer.querySelector('.col-12');
    analysisContainer.style.display = 'block';
    const loadingMessage = (
        'Preparing the prompt and calling the remote AI to get details ' +
        `for ${selectedClub} for the season ${selectedSeason}. ` +
        'This may take 30 seconds or more.'
    );
    analysisContent.innerHTML = `<p>${loadingMessage}</p>`;
    
    // Disable button during request
    const btn = document.getElementById('get-analysis-btn');
    btn.disabled = true;
    btn.textContent = 'Loading...';
    
    // Fetch analysis
    const url = (
        '{% url "club_analysis:get_club_season_analysis" %}?club=' +
        encodeURIComponent(selectedClub) +
        '&season=' +
        encodeURIComponent(selectedSeason)
    );
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Change loading text to "Processing response"
            analysisContent.innerHTML = '<p>Processing response...</p>';
            
            // Re-enable button
            btn.disabled = false;
            btn.textContent = 'Get analysis';
            
            if (data.error) {
                // Show error message
                analysisContent.innerHTML = (
                    '<div class="alert alert-danger" role="alert">' +
                    '<strong>Error:</strong> ' + data.error +
                    '</div>'
                );
            } else if (data.html) {
                // Show HTML content
                analysisContent.innerHTML = data.html;
            } else {
                // Unknown error
                analysisContent.innerHTML = (
                    '<div class="alert alert-danger" role="alert">' +
                    '<strong>Error:</strong> Unknown error occurred' +
                    '</div>'
                );
            }
        })
        .catch(error => {
            // Re-enable button
            btn.disabled = false;
            btn.textContent = 'Get analysis';
            
            // Show error
            analysisContent.innerHTML = (
                '<div class="alert alert-danger" role="alert">' +
                '<strong>Error:</strong> ' + error.message +
                '</div>'
            );
            console.error('Error fetching analysis:', error);
        });
}
</script>
{% endblock %}
