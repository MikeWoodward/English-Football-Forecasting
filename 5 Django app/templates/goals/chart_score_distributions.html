{% extends 'base.html' %}

{% block title %}{{ title }} - English Football League Analysis{% endblock %}

{% block extra_css %}
<!-- Bokeh CSS -->
<link rel="stylesheet" href="https://cdn.bokeh.org/bokeh/release/bokeh-3.8.0.min.css" type="text/css" />
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title text-center mb-0">{{ title }}</h1>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-12">
                        <a href="{% url 'goals:dashboard' %}" 
                           class="btn btn-secondary mb-3">
                            ‚Üê Back to Goals Dashboard
                        </a>
                    </div>
                </div>
                
                <!-- Chart - Full Width -->
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container" 
                             style="display: flex; flex-direction: column;">
                            <div style="width: 100%; display: block; clear: both;">
                                {{ div|safe }}
                            </div>
                            <!-- Year Slider - Under Chart (for Goals) -->
                            {% if min_year and max_year and current_year %}
                            <div style="width: 100%; margin-top: 20px; display: block; clear: both;">
                                <label for="year-slider" 
                                       class="form-label">
                                    Season start year: 
                                    <span id="year-value">
                                        {{ current_year }}
                                    </span>
                                </label>
                                <input type="range" 
                                       class="form-range" 
                                       id="year-slider" 
                                       style="width: 100%; display: block;"
                                       min="{{ min_year }}" 
                                       max="{{ max_year }}" 
                                       step="1" 
                                       value="{{ current_year }}">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Chart Controls - Under Chart -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Chart Controls</h5>
                            </div>
                            <div class="card-body">
                                <p class="analysis-text">{{ chart_controls }}
								</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Details - Under Chart Controls -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Analysis</h5>
                            </div>
                            <div class="card-body">
                                <p class="analysis-text">
                                    {{ description|linebreaksbr }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bokeh JS -->
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.8.0.min.js"></script>
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.8.0.min.js"></script>
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.8.0.min.js"></script>

{{ script|safe }}

{% if min_year and max_year and current_year %}
<script>
    // Update year slider display and plot
    document.addEventListener('DOMContentLoaded', function() {
        const yearSlider = document.getElementById(
            'year-slider'
        );
        const yearValue = document.getElementById(
            'year-value'
        );
        
        if (yearSlider && yearValue) {
            // Update display value on input
            yearSlider.addEventListener('input', function() {
                yearValue.textContent = this.value;
            });
            
            // Update plot data on change (when user releases slider)
            yearSlider.addEventListener('change', function() {
                updateScoreDistributionPlot();
            });
        }
    });
    
    /**
     * Update the score distribution plot with new data for the selected season.
     * 
     * Fetches data from the API based on the current year slider selection,
     * then updates the Bokeh plot.
     */
    function updateScoreDistributionPlot() {
        // Get the selected year value from the slider input element
        const yearSlider = document.getElementById('year-slider');
        // Get the span element that displays the year value
        const yearValue = document.getElementById('year-value');
        
        // Check if required elements exist
        if (!yearSlider || !yearValue) {
            console.error('Year slider or value display element not found');
            return;
        }
        
        // Parse the slider value as an integer
        const seasonStart = parseInt(yearSlider.value, 10);
        
        // Validate season start is a valid number
        if (isNaN(seasonStart)) {
            console.error('Invalid season start value:', yearSlider.value);
            alert('Invalid year selected. Please try again.');
            return;
        }

        // Show loading state by updating the display text
        const originalText = yearValue.textContent;
        yearValue.textContent = seasonStart + ' (loading...)';

        // Get the API endpoint URL
        // Construct URL path using callback variable from context
        const callbackName = '{{ callback }}';
        const urlPath = callbackName.replace(/_/g, '-');
        const apiUrl = '/goals/' + urlPath + '/' + seasonStart + '/';

        // Fetch data from API
        fetch(apiUrl)
            .then(response => {
                // Check if the HTTP response is successful
                if (!response.ok) {
                    throw new Error(
                        'Network response was not ok: ' + response.status
                    );
                }
                // Parse the JSON response
                return response.json();
            })
            .then(data => {
                // Check if the API returned an error
                if (data.error) {
                    console.error('Error fetching data:', data.error);
                    alert('Error loading score distribution data: ' + data.error);
                    // Restore original text on error
                    yearValue.textContent = originalText;
                    return;
                }

                // Update the Bokeh plot with new data
                updateBokehScoreDistributionPlot(data, seasonStart);
                // Update the year slider value display, removing loading text
                yearValue.textContent = seasonStart;
            })
            .catch(error => {
                // Handle network or parsing errors
                console.error('Error fetching score distribution data:', error);
                alert('Error loading data. Please try again.');
                // Restore original text on error
                yearValue.textContent = originalText;
            });
    }
    
    /**
     * Update the Bokeh score distribution plot with new data.
     * 
     * @param {Object} data - The JSON data from the API
     * @param {number} seasonStart - The season start year
     */
    function updateBokehScoreDistributionPlot(data, seasonStart) {
        // Implementation to be added
        console.log('updateBokehScoreDistributionPlot', data, seasonStart);
    }
    
</script>
{% endif %}
{% endblock %}

